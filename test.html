<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>VR Demo Player - test.mp4</title>

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <style>
      html, body { width: 100%; height: 100%; margin: 0; background: #000; }
      * { -webkit-tap-highlight-color: transparent; user-select: none; }
    </style>

    <script>
      AFRAME.registerComponent("demo-player", {
        init: function () {
          const scene = this.el.sceneEl;

          const video = document.getElementById("video360");

          const startPanel = document.getElementById("startPanel");
          const endPanel = document.getElementById("endPanel");

          const startBtn = document.getElementById("startBtn");
          const replayBtn = document.getElementById("replayBtn");
          const exitBtn = document.getElementById("exitBtn");

          const vrExitHud = document.getElementById("vrExitHud");
          const vrExitBtn = document.getElementById("vrExitBtn");

          const safePlay = async () => {
            try {
              await video.play();
            } catch (e) {
              console.warn("Video play blocked:", e);
              startPanel.setAttribute("visible", "true");
            }
          };

          const enterImmersiveIfPossible = async () => {
            try {
              if (scene && scene.enterVR && !scene.is("vr-mode")) {
                scene.enterVR();
              }
            } catch (e) {
              console.warn("enterVR failed:", e);
            }
          };

          const startDemo = async () => {
            startPanel.setAttribute("visible", "false");
            endPanel.setAttribute("visible", "false");

            video.currentTime = 0;
            await safePlay();
            await enterImmersiveIfPossible();
          };

          const replayDemo = async () => {
            endPanel.setAttribute("visible", "false");
            video.currentTime = 0;
            await safePlay();
          };

          const exitDemo = () => {
            try { video.pause(); } catch (_) {}

            // Exit VR if currently in VR
            try {
              if (scene && scene.exitVR && scene.is("vr-mode")) scene.exitVR();
            } catch (_) {}

            startPanel.setAttribute("visible", "true");
            endPanel.setAttribute("visible", "false");
          };

          const exitVROnly = () => {
            try {
              if (scene && scene.exitVR && scene.is("vr-mode")) {
                scene.exitVR();
              }
            } catch (e) {
              console.warn("exitVR failed:", e);
            }
          };

          // Button bindings
          startBtn.addEventListener("click", startDemo);
          replayBtn.addEventListener("click", replayDemo);
          exitBtn.addEventListener("click", exitDemo);
          vrExitBtn.addEventListener("click", exitVROnly);

          // Show end panel when video ends
          video.addEventListener("ended", () => {
            endPanel.setAttribute("visible", "true");
          });

          // VR enter/exit handling for HUD visibility
          scene.addEventListener("enter-vr", () => {
            vrExitHud.setAttribute("visible", "true");
          });

          scene.addEventListener("exit-vr", () => {
            vrExitHud.setAttribute("visible", "false");
          });

          // Initial state
          startPanel.setAttribute("visible", "true");
          endPanel.setAttribute("visible", "false");
          vrExitHud.setAttribute("visible", "false");
        },
      });
    </script>
  </head>

  <body>
    <a-scene
      demo-player
      renderer="colorManagement: true;"
      background="color: #000000"
      vr-mode-ui="enabled: true"
      embedded
    >
      <a-assets>
        <!-- Put test.mp4 in the same folder as this index.html -->
        <video
          id="video360"
          src="test.mp4"
          preload="auto"
          crossorigin="anonymous"
          playsinline
          webkit-playsinline
        ></video>
      </a-assets>

      <!-- 360 videosphere -->
      <a-videosphere src="#video360" rotation="0 -90 0"></a-videosphere>

      <!-- Camera + gaze cursor + VR Exit HUD -->
      <a-entity id="rig">
        <a-camera position="0 1.6 0" look-controls="reverseMouseDrag: false">
          <a-cursor
            id="cursor"
            fuse="true"
            fuse-timeout="1000"
            raycaster="objects: .clickable; far: 10"
          ></a-cursor>

          <!-- VR Exit Button (HUD, head-locked) -->
          <a-entity id="vrExitHud" position="0 -0.60 -1.2" visible="false">
            <a-plane
              id="vrExitBtn"
              class="clickable"
              width="0.85"
              height="0.22"
              material="color: #FFFFFF; shader: flat; opacity: 0.90"
            ></a-plane>
            <a-text
              value="Exit VR"
              align="center"
              color="#000000"
              width="1.2"
              position="0 0 0.01"
            ></a-text>
          </a-entity>
        </a-camera>
      </a-entity>

      <!-- Start Panel -->
      <a-entity id="startPanel" position="0 1.6 -2.2" visible="true">
        <a-plane
          width="2.2"
          height="1.2"
          material="color: #000000; shader: flat; opacity: 0.92"
        ></a-plane>

        <a-text
          value="Demo video (test.mp4)\nGaze the button to start"
          align="center"
          color="#FFFFFF"
          width="2.0"
          position="0 0.25 0.01"
        ></a-text>

        <!-- Start button: clickable MUST be on the plane -->
        <a-entity position="0 -0.35 0.02">
          <a-plane
            id="startBtn"
            class="clickable"
            width="1.6"
            height="0.28"
            material="color: #FFFFFF; shader: flat; opacity: 0.95"
          ></a-plane>
          <a-text
            value="Start Demo"
            align="center"
            color="#000000"
            width="1.8"
            position="0 0 0.01"
          ></a-text>
        </a-entity>
      </a-entity>

      <!-- End Panel -->
      <a-entity id="endPanel" position="0 1.6 -2.2" visible="false">
        <a-plane
          width="2.2"
          height="1.2"
          material="color: #000000; shader: flat; opacity: 0.92"
        ></a-plane>

        <a-text
          value="Video ended"
          align="center"
          color="#FFFFFF"
          width="2.0"
          position="0 0.30 0.01"
        ></a-text>

        <!-- Replay button -->
        <a-entity id="replayWrap" position="0 0.00 0.02">
          <a-plane
            id="replayBtn"
            class="clickable"
            width="1.6"
            height="0.28"
            material="color: #FFFFFF; shader: flat; opacity: 0.95"
          ></a-plane>
          <a-text
            value="Replay"
            align="center"
            color="#000000"
            width="1.8"
            position="0 0 0.01"
          ></a-text>
        </a-entity>

        <!-- Exit button -->
        <a-entity id="exitWrap" position="0 -0.38 0.02">
          <a-plane
            id="exitBtn"
            class="clickable"
            width="1.6"
            height="0.28"
            material="color: #FFFFFF; shader: flat; opacity: 0.95"
          ></a-plane>
          <a-text
            value="Exit"
            align="center"
            color="#000000"
            width="1.8"
            position="0 0 0.01"
          ></a-text>
        </a-entity>
      </a-entity>
    </a-scene>
  </body>
</html>
