<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>VR Demo Player - test.mp4</title>

    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <style>
      html, body { width: 100%; height: 100%; margin: 0; background: #000; }
      * { -webkit-tap-highlight-color: transparent; user-select: none; }
    </style>

    <script>
      // Simple hover feedback (works for gaze + controller + mouse)
      AFRAME.registerComponent("hover-feedback", {
        schema: { hoverColor: { default: "#DDDDDD" }, baseColor: { default: "#FFFFFF" } },
        init: function () {
          const el = this.el;
          const base = this.data.baseColor;
          const hover = this.data.hoverColor;

          el.setAttribute("material", "color", base);

          el.addEventListener("mouseenter", () => {
            el.setAttribute("material", "color", hover);
            console.log("[hover]", el.id);
          });
          el.addEventListener("mouseleave", () => {
            el.setAttribute("material", "color", base);
          });
          el.addEventListener("click", () => {
            console.log("[click]", el.id);
          });
        },
      });

      AFRAME.registerComponent("demo-player", {
        init: function () {
          const scene = this.el.sceneEl;

          const video = document.getElementById("video360");

          const startPanel = document.getElementById("startPanel");
          const endPanel = document.getElementById("endPanel");

          const startBtn = document.getElementById("startBtn");
          const replayBtn = document.getElementById("replayBtn");
          const exitBtn = document.getElementById("exitBtn");

          const vrExitHud = document.getElementById("vrExitHud");
          const vrExitBtn = document.getElementById("vrExitBtn");

          const safePlay = async () => {
            try {
              await video.play();
            } catch (e) {
              console.warn("Video play blocked:", e);
              // If play is blocked, show start panel again
              startPanel.setAttribute("visible", "true");
            }
          };

          const enterImmersiveIfPossible = async () => {
            try {
              if (scene && scene.enterVR && !scene.is("vr-mode")) {
                scene.enterVR();
              }
            } catch (e) {
              console.warn("enterVR failed:", e);
            }
          };

          const startDemo = async () => {
            console.log("== startDemo triggered ==");
            startPanel.setAttribute("visible", "false");
            endPanel.setAttribute("visible", "false");

            video.currentTime = 0;
            await safePlay();
            await enterImmersiveIfPossible();
          };

          const replayDemo = async () => {
            console.log("== replayDemo triggered ==");
            endPanel.setAttribute("visible", "false");
            video.currentTime = 0;
            await safePlay();
          };

          const exitDemo = () => {
            console.log("== exitDemo triggered ==");
            try { video.pause(); } catch (_) {}

            try {
              if (scene && scene.exitVR && scene.is("vr-mode")) scene.exitVR();
            } catch (_) {}

            startPanel.setAttribute("visible", "true");
            endPanel.setAttribute("visible", "false");
          };

          const exitVROnly = () => {
            console.log("== exitVROnly triggered ==");
            try {
              if (scene && scene.exitVR && scene.is("vr-mode")) scene.exitVR();
            } catch (e) {
              console.warn("exitVR failed:", e);
            }
          };

          // Bind buttons
          startBtn.addEventListener("click", startDemo);
          replayBtn.addEventListener("click", replayDemo);
          exitBtn.addEventListener("click", exitDemo);
          vrExitBtn.addEventListener("click", exitVROnly);

          // End detection
          video.addEventListener("ended", () => {
            endPanel.setAttribute("visible", "true");
          });

          // VR enter/exit handling
          scene.addEventListener("enter-vr", () => {
            vrExitHud.setAttribute("visible", "true");
          });
          scene.addEventListener("exit-vr", () => {
            vrExitHud.setAttribute("visible", "false");
          });

          // Initial state
          startPanel.setAttribute("visible", "true");
          endPanel.setAttribute("visible", "false");
          vrExitHud.setAttribute("visible", "false");
        },
      });
    </script>
  </head>

  <body>
    <a-scene
      demo-player
      renderer="colorManagement: true;"
      background="color: #000000"
      vr-mode-ui="enabled: true"
      embedded
    >
      <a-assets>
        <video
          id="video360"
          src="test.mp4"
          preload="auto"
          crossorigin="anonymous"
          playsinline
          webkit-playsinline
        ></video>
      </a-assets>

      <!-- 360 videosphere -->
      <a-videosphere src="#video360" rotation="0 -90 0"></a-videosphere>

      <!-- Camera rig -->
      <a-entity id="rig">
        <a-camera position="0 1.6 0" look-controls="reverseMouseDrag: false">
          <!-- Gaze cursor (fuse) -->
          <a-cursor
            id="cursor"
            fuse="true"
            fuse-timeout="900"
            raycaster="objects: .clickable; far: 20; interval: 50"
          ></a-cursor>

          <!-- VR Exit HUD -->
          <a-entity id="vrExitHud" position="0 -0.62 -1.25" visible="false">
            <a-plane
              id="vrExitBtn"
              class="clickable"
              hover-feedback="baseColor: #FFFFFF; hoverColor: #DDDDDD"
              width="0.9"
              height="0.24"
              position="0 0 0.08"
              material="shader: flat; opacity: 0.92"
            ></a-plane>
            <a-text
              value="Exit VR"
              align="center"
              color="#000000"
              width="1.2"
              position="0 0 0.10"
            ></a-text>
          </a-entity>
        </a-camera>

        <!-- Controller laser (optional but very reliable on Quest) -->
        <a-entity laser-controls="hand: right" raycaster="objects: .clickable; far: 20"></a-entity>
        <a-entity laser-controls="hand: left"  raycaster="objects: .clickable; far: 20"></a-entity>
      </a-entity>

      <!-- Start Panel -->
      <a-entity id="startPanel" position="0 1.6 -2.2" visible="true">
        <!-- Background plane pushed BACK to avoid intercepting rays -->
        <a-plane
          width="2.2"
          height="1.2"
          position="0 0 -0.06"
          material="color: #000000; shader: flat; opacity: 0.92"
        ></a-plane>

        <a-text
          value="Demo video (test.mp4)\nGaze or click the button to start"
          align="center"
          color="#FFFFFF"
          width="2.0"
          position="0 0.25 0.02"
        ></a-text>

        <!-- Start button plane pushed FORWARD clearly -->
        <a-entity position="0 -0.35 0.00">
          <a-plane
            id="startBtn"
            class="clickable"
            hover-feedback="baseColor: #FFFFFF; hoverColor: #DDDDDD"
            width="1.65"
            height="0.30"
            position="0 0 0.08"
            material="shader: flat; opacity: 0.95"
          ></a-plane>
          <a-text
            value="Start Demo"
            align="center"
            color="#000000"
            width="1.9"
            position="0 0 0.10"
          ></a-text>
        </a-entity>
      </a-entity>

      <!-- End Panel -->
      <a-entity id="endPanel" position="0 1.6 -2.2" visible="false">
        <a-plane
          width="2.2"
          height="1.2"
          position="0 0 -0.06"
          material="color: #000000; shader: flat; opacity: 0.92"
        ></a-plane>

        <a-text
          value="Video ended"
          align="center"
          color="#FFFFFF"
          width="2.0"
          position="0 0.30 0.02"
        ></a-text>

        <a-entity position="0 0.00 0.00">
          <a-plane
            id="replayBtn"
            class="clickable"
            hover-feedback="baseColor: #FFFFFF; hoverColor: #DDDDDD"
            width="1.65"
            height="0.30"
            position="0 0 0.08"
            material="shader: flat; opacity: 0.95"
          ></a-plane>
          <a-text
            value="Replay"
            align="center"
            color="#000000"
            width="1.9"
            position="0 0 0.10"
          ></a-text>
        </a-entity>

        <a-entity position="0 -0.38 0.00">
          <a-plane
            id="exitBtn"
            class="clickable"
            hover-feedback="baseColor: #FFFFFF; hoverColor: #DDDDDD"
            width="1.65"
            height="0.30"
            position="0 0 0.08"
            material="shader: flat; opacity: 0.95"
          ></a-plane>
          <a-text
            value="Exit"
            align="center"
            color="#000000"
            width="1.9"
            position="0 0 0.10"
          ></a-text>
        </a-entity>
      </a-entity>
    </a-scene>
  </body>
</html>
