<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <title>VR å®éªŒ - å…¨æ™¯å£°éŸ³é—®å·</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>


    <script src="https://cdn.jsdelivr.net/npm/aframe-msdf-text-component@1.3.0/dist/aframe-msdf-text-component.min.js"></script>
    
    <!-- âœ… ä¸­æ–‡å­—ä½“æ”¯æŒï¼ˆæ€æºé»‘ä½“ JSONï¼‰ -->
    <script>
        const CN_FONT = "https://cdn.jsdelivr.net/gh/relief-melone/aframe-cn-fonts@main/fonts/NotoSansSC-Regular.json";
    </script>
    
    <style>
      body { margin: 0; background: black; color: white; font-family: sans-serif; }
      #startBox, #endBox {
        position: absolute; top: 30px; left: 50%; transform: translateX(-50%);
        background: rgba(0,0,0,0.6); padding: 20px; border-radius: 10px; text-align: center;
      }
      button {
        font-size: 20px; margin: 8px; padding: 10px 20px; border: none;
        border-radius: 6px; background: #fff; cursor: pointer;
      }
      button:hover { background: rgb(200, 162, 209); }
      #endBox { display: none; }
    </style>
  </head>

  <body>
    <!-- è§†é¢‘èµ„æº -->
    <video id="video" crossorigin="anonymous" webkit-playsinline playsinline controls></video>

    <!-- VR åœºæ™¯ -->
    <a-scene background="color: black">
      <!-- âœ… è§†é¢‘çƒï¼šåªæ¸²æŸ“å†…å£ï¼Œä¸æŒ¡å°„çº¿ -->
      <a-videosphere
        id="sphere"
        src="#video"
        rotation="0 -90 0"
        radius="500"
        side="back"
        material="side: back; transparent: false">
      </a-videosphere>
    
      <!-- âœ… æ‘„åƒæœº + å…‰æ ‡ -->
      <a-entity id="cameraRig"
          camera
          look-controls="magicWindowTrackingEnabled: false;"
          position="0 1.6 0">
        <a-cursor
          cursor="fuse: true;"
          fuse="true"
          fuse-timeout="1200"
          raycaster="objects: .clickable; far: 1000; interval: 200;"
          position="0 0 -1"
          geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
          material="color: yellow; shader: flat">
        </a-cursor>
      </a-entity>
    
      <!-- âœ… VR é—®å· UI -->
      <a-entity id="vrUI"
                visible="false"
                position="0 1.3 -3"
                look-at="[camera]">
        <a-text id="questionText"
                value=""
                color="white"
                align="center"
                width="6"
                position="0 1 0">
        </a-text>
      </a-entity>
      <script>
        // === å…‰æ ‡ç‚¹å‡»ç›‘å¬å…¼å®¹å¤„ç† ===
        AFRAME.registerComponent('cursor-listener', {
          init: function () {
            const el = this.el;
            // é¼ æ ‡æˆ–æ§åˆ¶å™¨ç‚¹å‡»
            el.addEventListener('click', evt => {
              console.log('âœ… click äº‹ä»¶è§¦å‘:', el.getAttribute('data-value'), el);
              el.emit('chosen', {value: el.getAttribute('data-value')});
            });
            // å‡è§†å®Œæˆè§¦å‘
            el.addEventListener('fuseend', evt => {
              console.log('ğŸ”¥ fuseend äº‹ä»¶è§¦å‘:', el.getAttribute('data-value'), el);
              el.emit('chosen', {value: el.getAttribute('data-value')});
            });
          }
        });
        
        // === å…‰æ ‡å…¨å±€è°ƒè¯• ===
        document.querySelector('a-cursor').addEventListener('fusing', () => {
          console.log('ğŸŸ¡ å…‰æ ‡æ­£åœ¨èšç„¦...');
        });
        document.querySelector('a-cursor').addEventListener('click', () => {
          console.log('ğŸŸ¢ å…‰æ ‡ click äº‹ä»¶è§¦å‘');
        });
        document.querySelector('a-cursor').addEventListener('fuseend', () => {
          console.log('ğŸ”µ å…‰æ ‡ fuseend äº‹ä»¶è§¦å‘');
        });
        </script>
        
    </a-scene>
    

    <!-- å¼€å§‹ / ç»“æŸ UI -->
    <div id="startBox">
      <h2>ç‚¹å‡»å¼€å§‹å®éªŒ</h2>
      <button onclick="startExperiment()">å¼€å§‹</button>
    </div>
    <div id="endBox">
      <h2>å®éªŒç»“æŸï¼Œè°¢è°¢å‚ä¸ï¼</h2>
    </div>

    <script>
      // ======== å…¨å±€å˜é‡å®šä¹‰åŒºï¼ˆæ”¾åœ¨æ–‡ä»¶æœ€ä¸Šæ–¹ï¼‰ ========
      window.answers = [];                   // ä¿å­˜æ‰€æœ‰è¢«è¯•çš„é—®å·å›ç­”
      window.currentQuestionSelections = []; // å½“å‰é¢˜ç›®çš„é€‰æ‹©ç¼“å­˜

      //window.videos = ["videodemo.mp4", "video01.mp4", "video02.mp4"];
      window.current = -1;
      let answers = [];
      async function loadLatinOrderAndInit() {
        // 1ï¸âƒ£ è¾“å…¥è¢«è¯•ç¼–å·
        let pid = prompt("è¯·è¾“å…¥è¢«è¯•ç¼–å·ï¼ˆæ•°å­—ï¼Œä¾‹å¦‚ 1ã€2ã€3 ...ï¼‰");
        if (!pid) {
          alert("âŒ æœªè¾“å…¥ç¼–å·ï¼Œå®éªŒå·²ä¸­æ­¢ã€‚");
          return;
        }
        pid = parseInt(pid);
        console.log("ğŸ§© è¢«è¯•ç¼–å·:", pid);

        // 2ï¸âƒ£ è¯»å– latin_orders.json
        let orders;
        try {
          const response = await fetch("latin_orders.json");
          orders = await response.json();
        } catch (err) {
          alert("âš ï¸ æ— æ³•è¯»å– latin_orders.jsonï¼Œè¯·ç¡®è®¤æ–‡ä»¶åœ¨åŒç›®å½•ä¸‹ã€‚");
          console.error(err);
          return;
        }

        // 3ï¸âƒ£ é€‰æ‹©å¯¹åº”é¡ºåº
        if (pid < 1 || pid > orders.length) {
          alert(`âš ï¸ æ— æ•ˆç¼–å·ï¼š${pid}ï¼Œä»…æ”¯æŒ 1~${orders.length}`);
          return;
        }
        const order = orders[pid - 1];
        console.log("ğŸ¬ å½“å‰è¢«è¯•è§†é¢‘é¡ºåº:", order);

        // 4ï¸âƒ£ æ„å»ºè§†é¢‘æ–‡ä»¶åæ•°ç»„ï¼Œå¹¶åœ¨æœ€å‰åŠ ä¸Šæ¼”ç¤ºæ®µ
        const demoVideo = "videodemo.mp4";   // âœ… ä½ çš„ç¤ºèŒƒè§†é¢‘æ–‡ä»¶å
        const experimentVideos = order.map(i => `video${String(i).padStart(2, '0')}.mp4`);

        // âœ… æŠŠ demo æ”¾åœ¨æœ€å‰
        window.videos = [demoVideo, ...experimentVideos];

        // 5ï¸âƒ£ å¼€å§‹å®éªŒ
        console.log("âœ… è§†é¢‘æ’­æ”¾é¡ºåº:", window.videos);
        alert(`è¢«è¯• ${pid} çš„è§†é¢‘é¡ºåºå·²åŠ è½½ï¼š\n${window.videos.join(", ")}`);
     


      }

      // âš™ï¸ é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
      window.addEventListener("load", loadLatinOrderAndInit);


      const videoEl = document.getElementById("video");
      const startBox = document.getElementById("startBox");
      const endBox = document.getElementById("endBox");
      const vrUI = document.getElementById("vrUI");
      const questionText = document.getElementById("questionText");

      // æ‰€æœ‰é—®é¢˜
      window.questions = [
        {
          type: "multi",
          text: "ä½ æ³¨æ„åˆ°çš„å£°éŸ³æ¥æºï¼ˆå¯å¤šé€‰ï¼‰",
          options: ["æ— äººæœº / é£è¡Œå™¨", "äº¤é€šå£°", "è‡ªç„¶å£°ï¼ˆé£ã€é¸Ÿã€æ ‘å¶ï¼‰", "äººå£°", "èƒŒæ™¯éŸ³ä¹", "å…¶ä»–"]
        },
        {
          type: "multi",
          text: "ä½ è§‰å¾—ä¸»è¦çš„å£°éŸ³ç±»å‹æ˜¯ï¼ˆå¯å¤šé€‰ï¼‰",
          options: ["å—¡é¸£", "å°–å•¸", "æŒ¯åŠ¨", "å‘¼å•¸", "ä½é¢‘éš†éš†", "é—´æ­‡å™ªå£°"]
        },
        {
          type: "scale",
          text: "å¯¹ä»¥ä¸‹å…«ä¸ªå½¢å®¹è¯çš„åŒæ„ç¨‹åº¦ï¼Œ\nå·¦ -2 å®Œå…¨ä¸åŒæ„    å³ 2 å®Œå…¨åŒæ„",
          options: ["æ„‰å¿«", "æ··ä¹±", "æœ‰æ´»åŠ›", "å¹³æ·¡", "å¹³é™", "æ¼äºº", "äº‹ä»¶ä¸°å¯Œ", "å•è°ƒ"]
        }
      ];

      window.qIndex = 0; // å½“å‰é—®é¢˜åºå·
      window.currentQuestionSelections = [];

      // æ³¨å†Œç‚¹å‡»ç»„ä»¶ï¼ˆå‡è§†è§¦å‘ï¼‰
      AFRAME.registerComponent('clickable', {
        init: function () {
          const el = this.el;
          const handler = (e) => {
            const val = el.getAttribute('data-value');
            if (val) {
              console.log("âœ… è§¦å‘é€‰é¡¹:", val);
              selectOption(val);
            }
          };
          el.addEventListener('click', handler);
          el.addEventListener('fuseend', handler); // âœ… å‡è§†é€‰æ‹©
          el.addEventListener('mouseup', handler); // âœ… æ§åˆ¶å™¨ç‚¹é€‰
          el.addEventListener('mouseenter', () => el.setAttribute('color', '#666'));
          el.addEventListener('mouseleave', () => el.setAttribute('color', '#333'));
        }
      });

      function startExperiment() {
        startBox.style.display = "none";
        current = 0;
        playVideo(videos[current]);
      }

      function playVideo(name) {
        vrUI.setAttribute("visible", false);
        videoEl.muted = false;
        videoEl.src = name;
        videoEl.play().then(() => {
          console.log("â–¶ æ’­æ”¾è§†é¢‘:", name);
        }).catch(err => {
          alert("è¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®ä»¥å…è®¸å£°éŸ³ã€‚");
        });

        videoEl.onended = () => {
          console.log("ğŸ“º æ’­æ”¾ç»“æŸ:", name);
          window.currentQuestionSelections = [];
          showQuestion();
        };
      }
      //
      function showQuestion() {
        console.log("ğŸ“‹ æ­£åœ¨æ˜¾ç¤ºé—®é¢˜:", questions[qIndex].text);

        // âœ… æ¸…é™¤æ—§é—®é¢˜çš„UI
        vrUI.innerHTML = '';

        // âœ… æ•´ä½“ç¼©å°ä¸ä½ç½®è°ƒæ•´
        vrUI.setAttribute('scale', '0.6 0.6 0.6');
        vrUI.setAttribute('position', '0 2.6 -3');

        // âœ… è·å–å½“å‰é—®é¢˜å¯¹è±¡
        const q = questions[qIndex];

        // === èƒŒæ™¯æ¿ ===
        const bgPanel = document.createElement('a-plane');
        bgPanel.setAttribute('width', '6');
        bgPanel.setAttribute('height', '0.8');  // ç¨å¤§ä¸€ç‚¹åŒ…ä½æ–‡å­—
        bgPanel.setAttribute('color', 'black');
        bgPanel.setAttribute('opacity', '0.5');
        bgPanel.setAttribute('position', '0 1.2 -0.6');  // âœ… æ–‡å­—ä¸‹æ–¹ä¸€ç‚¹ç‚¹
        vrUI.appendChild(bgPanel);

        // === é¢˜ç›®æ–‡å­— ===
        const questionText = document.createElement('a-entity');
        questionText.removeAttribute("text");
        questionText.removeAttribute("msdf-text");
        questionText.setAttribute('text', {
          value: `${qIndex + 1}. ${q.text}`,
          align: 'center',
          color: 'white',
          width: 4,                // âœ… å­—å·æ”¾å¤§
          wrapCount: 28,           // âœ… è‡ªåŠ¨æ¢è¡Œï¼Œé˜²æ­¢å¤ªå®½
          font: './font.json',
          shader: 'msdf',
          negate: false,
          outlineColor: '#000',
          outlineWidth: 0.06       // âœ… æ¯”é€‰é¡¹ç¨ç²—ä¸€ç‚¹
        });
        questionText.setAttribute('position', '0 1.2 -0.5');  // âœ… ä¸èƒŒæ™¯æ¿å¯¹é½


        vrUI.appendChild(questionText);

        // === æ ¹æ®é¢˜å‹ç”Ÿæˆé€‰é¡¹ ===
        if (q.type === 'multi') {
          createOptions(q.options);
        } else if (q.type === 'scale') {
          createScale(q.options);
        }

        // âœ… æ˜¾ç¤ºé—®å·
        vrUI.setAttribute('visible', true);
      }




      function clearOptions() {
        document.querySelectorAll('.opt').forEach(el => el.parentNode.removeChild(el));
      }

      // åˆ›å»ºæ™®é€šå¤šé€‰é¡¹æŒ‰é’®
       function createOptions(opts) {
        let y = 0;
        opts.forEach((o, i) => {
          const wrapper = document.createElement('a-entity');
          wrapper.setAttribute('position', `0 ${-i * 0.6 - 0.5} -0.5`);

          // âœ… èƒŒæ™¯çŸ©å½¢æŒ‰é’®
          const bg = document.createElement('a-plane');
          bg.setAttribute('width', '4');
          bg.setAttribute('height', '0.35');
          bg.setAttribute('opacity', '0.75');
          bg.setAttribute('color', '#333');
          bg.setAttribute('class', 'opt clickable');
          bg.setAttribute('raycastable', '');
          bg.setAttribute('data-value', o);

          // âœ… å…³é”®è¡¥å……ï¼šè®©æŒ‰é’®å…·å¤‡äº‹ä»¶é€»è¾‘
          bg.setAttribute('cursor-listener', '');
          bg.addEventListener('chosen', e => selectOption(e.detail.value));
          // âœ… é€‰ä¸­åé¦ˆé€»è¾‘ï¼šç‚¹å‡»åˆ‡æ¢æ”¾å¤§+å˜äº®æ•ˆæœ
          bg.addEventListener('click', () => {
            const selected = bg.getAttribute('data-selected') === 'true';
            bg.setAttribute('data-selected', !selected);

            if (!selected) {
              // ğŸ”¹ è¢«é€‰ä¸­ï¼šæ”¾å¤§+å˜äº®
              bg.setAttribute('scale', '1.2 1.2 1.2');
              bg.setAttribute('color', '#777');
            } else {
              // ğŸ”¹ å–æ¶ˆé€‰ä¸­ï¼šæ¢å¤
              bg.setAttribute('scale', '1 1 1');
              bg.setAttribute('color', '#333');
            }
          });

          // âœ… æ–‡å­—æ ‡ç­¾
          const label = document.createElement('a-entity');
          label.setAttribute('text', {
            value: o,
            align: 'center',
            color: 'white',
            width: 3,
            wrapCount: 20,
            font: './font.json',
            shader: 'msdf',
            negate: false,
            outlineColor: '#000',
            outlineWidth: 0.05
          });
          label.setAttribute('position', '0 0 0.01');


          wrapper.appendChild(bg);
          wrapper.appendChild(label);
          vrUI.appendChild(wrapper);
        });

        // æ·»åŠ â€œä¸‹ä¸€é¢˜â€æŒ‰é’®
        const wrapper = document.createElement('a-entity');
        wrapper.setAttribute('position', '0 -4 0.01');

        const nextBtn = document.createElement('a-plane');
        nextBtn.setAttribute('width', '6');
        nextBtn.setAttribute('height', '0.6');
        nextBtn.setAttribute('color', 'black');
        nextBtn.setAttribute('opacity', '0.5');
        nextBtn.setAttribute('raycastable', '');
        nextBtn.setAttribute('class', 'opt clickable');
        nextBtn.setAttribute('data-value', 'NEXT');

        // âœ… åŒæ ·ä¸ºâ€œä¸‹ä¸€é¢˜â€æŒ‰é’®æ·»åŠ äº¤äº’
        nextBtn.setAttribute('cursor-listener', '');
        nextBtn.addEventListener('chosen', e => selectOption(e.detail.value));

        const nextLabel = document.createElement('a-entity');
        nextLabel.setAttribute('text', {
          value: 'ä¸‹ä¸€é¢˜',
          align: 'center',
          color: 'white',
          width: 6,
          font: './font.json',
          shader: 'msdf',
          negate: false,
          outlineColor: '#000',
          outlineWidth: 0.05
        });
        nextLabel.setAttribute('position', '0 0 0.02');


        wrapper.appendChild(nextBtn);
        wrapper.appendChild(nextLabel);
        vrUI.appendChild(wrapper);
      } 


      // âœ… ä¸‹ä¸€æ®µè§†é¢‘æ’­æ”¾
      function showNextVideoPrompt() {
        // âœ… è·å–æ‘„åƒæœºå¹¶è®¡ç®—æ­£å‰æ–¹ä½ç½®
        const camera = document.querySelector('[camera]');
        const camObj = camera.object3D;
        const front = new THREE.Vector3(0, 0, -3);
        front.applyQuaternion(camObj.quaternion);  // å–æ‘„åƒæœºæœå‘
        const worldPos = new THREE.Vector3();
        camObj.getWorldPosition(worldPos);

        // âœ… å°†é—®å·UIæ”¾åˆ°æ‘„åƒæœºå‰æ–¹3ç±³å¤„
        vrUI.object3D.position.copy(worldPos.clone().add(front));
        vrUI.object3D.lookAt(worldPos);
        vrUI.setAttribute("visible", true);
        vrUI.innerHTML = "";

        // âœ… èƒŒæ™¯æ¿
        const panel = document.createElement("a-plane");
        panel.setAttribute("width", "6");
        panel.setAttribute("height", "1.2");
        panel.setAttribute("color", "black");
        panel.setAttribute("opacity", "0.6");
        panel.setAttribute("position", "0 0 0");
        vrUI.appendChild(panel);

        // âœ… æç¤ºæ–‡å­—
        const label = document.createElement("a-entity");
        label.setAttribute("text", {
          value: "è¯·ç‚¹å‡»å¼€å§‹ä¸‹ä¸€ä¸ªè§†é¢‘",
          align: "center",
          color: "white",
          width: 3,
          font: "./font.json",
          shader: "msdf",
          negate: false,
          outlineColor: "#000",
          outlineWidth: 0.05
        });
        label.setAttribute("position", "0 0.3 0.01");
        vrUI.appendChild(label);


        // âœ… â€œä¸‹ä¸€è§†é¢‘â€æŒ‰é’®
        const nextBtn = document.createElement("a-plane");
        nextBtn.setAttribute("width", "8");
        nextBtn.setAttribute("height", "0.6");
        nextBtn.setAttribute("color", "black");
        nextBtn.setAttribute("opacity", "0.5");
        nextBtn.setAttribute("class", "clickable");
        nextBtn.setAttribute("data-value", "NEXTVIDEO");
        nextBtn.setAttribute("position", "0 -0.3 0.01");
        nextBtn.setAttribute("material", "side: double");
        vrUI.appendChild(nextBtn);

        const btnLabel = document.createElement("a-text");
        btnLabel.setAttribute("value", "ä¸‹ä¸€è§†é¢‘");
        btnLabel.setAttribute("align", "center");
        btnLabel.setAttribute("color", "black");
        btnLabel.setAttribute("width", "0.5");
        btnLabel.setAttribute("position", "0 -0.3 0.02");
        btnLabel.setAttribute("font", "./font.json");
        btnLabel.setAttribute("shader", "msdf");
        btnLabel.setAttribute("negate", "true");
        vrUI.appendChild(btnLabel);

        console.log("ğŸŸ¢ [DEBUG] showNextVideoPrompt(): UI æ”¾ç½®åœ¨æ‘„åƒæœºå‰æ–¹", vrUI.object3D.position);
      }


    // === åˆ›å»ºäº”ç‚¹é‡è¡¨ ===
    function createScale(opts) {
      console.log('ğŸ”§ [DEBUG] å¼€å§‹åˆ›å»ºäº”ç‚¹é‡è¡¨');

      opts.forEach((word, i) => {
        // === å·¦ä¾§å½¢å®¹è¯æ–‡å­— ===
        const labelWrapper = document.createElement('a-entity');
        labelWrapper.setAttribute('position', `-3.5 ${-i * 0.6 - 0.3} 0`);

        const bg = document.createElement('a-plane');
        bg.setAttribute('width', '1.5');
        bg.setAttribute('height', '0.5');
        bg.setAttribute('color', '#333');
        bg.setAttribute('opacity', '0.8');
        bg.setAttribute('position', '1 0 -0.01');

        const label = document.createElement('a-entity');
        label.setAttribute('text', {
          value: word,
          align: 'right',
          color: 'white',
          width: 2.5,
          wrapCount: 12,
          font: './font.json',
          shader: 'msdf',
          negate: false
        });
        label.setAttribute('position', '0.2 0 0');

        labelWrapper.appendChild(bg);
        labelWrapper.appendChild(label);
        labelWrapper.setAttribute('class', 'opt');
        vrUI.appendChild(labelWrapper);

        // === äº”ç‚¹æ•°å­—æ ‡ç­¾ï¼ˆ-2 -1 0 1 2ï¼‰===
        const scaleNums = [-2, -1, 0, 1, 2];
        scaleNums.forEach(num => {
          const numLabel = document.createElement('a-entity');
          numLabel.setAttribute('msdf-text', {
            text: `${num}`,
            font: CN_FONT,
            align: 'center',
            color: '#FFFFFF',
            negate: false
          });
          const x = (num + 2) * 0.7 - 1.4;
          const y = -i * 0.6 - 0.1;  // ç¨é«˜äºæŒ‰é’®
          numLabel.setAttribute('position', `${x} ${y} 0.02`);
          vrUI.appendChild(numLabel);
        });

        // === æŒ‰é’®åœ†ç‚¹ ===
        for (let s = -2; s <= 2; s++) {
          const btn = document.createElement('a-circle');
          btn.setAttribute('radius', '0.15');
          btn.setAttribute('raycastable', '');

          let color = '#FFD6A0';
          if (Math.abs(s) === 1) color = '#FFA640';
          if (Math.abs(s) === 2) color = '#FF6A00';

          btn.setAttribute('color', color);
          btn.setAttribute('material', 'shader: flat; opacity: 0.8; transparent: true; side: double');
          btn.setAttribute('position', `${(s + 2) * 0.7 - 1.4} ${-i * 0.6 - 0.3} -0.01`);
          btn.setAttribute('class', 'opt clickable');
          btn.setAttribute('data-value', `${word}:${s}`);
          btn.setAttribute('cursor-listener', '');
          btn.addEventListener('chosen', e => selectOption(e.detail.value));

          vrUI.appendChild(btn);
        }
      });

      // === æäº¤æŒ‰é’® ===
      const nextBtn = document.createElement('a-plane');
      nextBtn.setAttribute('class', 'opt clickable');
      nextBtn.setAttribute('raycastable', '');
      nextBtn.setAttribute('cursor-listener', '');
      nextBtn.setAttribute('position', '0 -6 -0.5');
      nextBtn.setAttribute('width', '2');
      nextBtn.setAttribute('height', '0.6');
      nextBtn.setAttribute('color', 'black');
      nextBtn.setAttribute('opacity', '0.5');
      nextBtn.setAttribute('data-value', 'NEXTVIDEO');

      nextBtn.setAttribute(
        'text',
        "value: ä¸‹ä¸€è§†é¢‘; align: center; color: white; font: ./font.json; shader: msdf; negate: false; width: 12; baseline: center;"
      );
      nextBtn.addEventListener('click', () => {
        console.log('ğŸŸ¢ NEXTVIDEO æŒ‰é’®ç‚¹å‡»è§¦å‘ selectOption()');
        window.selectOption('NEXTVIDEO');
      });
      vrUI.appendChild(nextBtn);

      console.log('âœ… [DEBUG] createScale å®Œæˆ');
    }



      // è¢«é€‰ä¸­æ—¶å¤„ç†
      function selectOption(val) {
        console.log("å½“å‰ qIndex =", window.qIndex, " / æ€»é¢˜æ•° =", window.questions.length);
        console.log("ğŸŸ£ [DEBUG] selectOption è¢«è°ƒç”¨, val =", val);
        console.log("é€‰ä¸­:", val);

        // âœ… ç¬¬ä¸€éƒ¨åˆ†ï¼šå¤„ç† NEXTVIDEOï¼ˆå¿…é¡»æ”¾æœ€å‰ï¼‰
        if (val === 'NEXTVIDEO') {
          console.log("ğŸŸ£ [DEBUG] selectOption æ”¶åˆ° NEXTVIDEO");

          // âœ… åœ¨åˆ‡è§†é¢‘å‰ä¿å­˜æœ€åä¸€é¢˜å›ç­”
          if (!window.answers) window.answers = [];

          window.answers.push({
            video: window.videos[window.current],
            question: window.questions[window.qIndex].text,
            response: [...window.currentQuestionSelections]
          });

          console.log("ğŸ’¾ [FINAL SAVE] å·²ä¿å­˜æœ€åä¸€é¢˜å›ç­”:", window.answers[window.answers.length - 1]);

          // âœ… æ¸…ç©ºå½“å‰é€‰æ‹©å¹¶éšè— UI
          window.currentQuestionSelections = [];
          vrUI.setAttribute("visible", false);

          // âœ… æ’­æ”¾ä¸‹ä¸€ä¸ªè§†é¢‘
          window.nextVideo();
          return;
        }


        // âœ… ç¬¬äºŒéƒ¨åˆ†ï¼šæ™®é€š NEXTï¼ˆé—®å·å†…éƒ¨ï¼‰
        if (val === 'NEXT') {
          // âœ… ç¡®ä¿ answers æ•°ç»„å­˜åœ¨
          if (!window.answers) window.answers = [];

          // âœ… ä¿å­˜å½“å‰é¢˜ç›®å›ç­”
          window.answers.push({
            video: window.videos[window.current],
            question: window.questions[window.qIndex].text,
            response: [...window.currentQuestionSelections]  // ç”¨æ‹·è´é˜²æ­¢åç»­æ¸…ç©º
          });

          console.log("ğŸ’¾ å·²ä¿å­˜å›ç­”:", window.answers[window.answers.length - 1]);

          // âœ… æ¸…ç©ºå½“å‰é€‰æ‹©
          window.currentQuestionSelections = [];

          // ====== ä»¥ä¸‹ä¿æŒä½ åŸæ¥çš„é€»è¾‘ä¸åŠ¨ ======
          if (window.qIndex < window.questions.length - 1) {
            window.qIndex++;
            console.log("â¡ï¸ åˆ‡æ¢åˆ°ä¸‹ä¸€é¢˜ qIndex =", window.qIndex);
            showQuestion();
          } else {
            console.log("âœ… æ‰€æœ‰é¢˜ç›®å®Œæˆï¼Œå‡†å¤‡è¿›å…¥ä¸‹ä¸€ä¸ªè§†é¢‘");
            vrUI.setAttribute("visible", false);
            setTimeout(() => {
              window.nextVideo();
            }, 1000);
          }
          return;
        }


        // âœ… ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ™®é€šé€‰é¡¹é€‰æ‹©ï¼ˆæ”¾å¤§ / è¿˜åŸï¼‰
        // === åˆ¤æ–­æ˜¯ä¸æ˜¯ scale é¢˜
        const isScale = window.questions[window.qIndex]?.type === 'scale';

        if (isScale && val.includes(':')) {
          // val ç¤ºä¾‹ï¼š'æ„‰å¿«:-2'
          const [word, score] = val.split(':');

          // å…ˆç§»é™¤è¯¥è¯ä¸‹çš„å·²æœ‰é€‰æ‹©
          const existing = document.querySelectorAll(`.clickable[data-value^="${word}:"]`);
          existing.forEach(btn => {
            const ring = btn.querySelector('a-ring');
            if (ring) btn.removeChild(ring);
          });

          // åˆ é™¤ä¹‹å‰å­˜å‚¨çš„è¯¥è¯è¯„åˆ†
          window.currentQuestionSelections = window.currentQuestionSelections.filter(v => !v.startsWith(`${word}:`));

          // æ·»åŠ æ–°é€‰æ‹©
          const clicked = Array.from(existing).find(btn => btn.getAttribute('data-value') === val);
          if (!clicked) return;

          // åŠ æè¾¹ï¼ˆç™½åœˆï¼‰
          const ring = document.createElement('a-ring');
          const ringId = `ring-${val.replace(/[^a-zA-Z0-9]/g, '')}`;
          ring.setAttribute('id', ringId);
          ring.setAttribute('radius-inner', '0.17');
          ring.setAttribute('radius-outer', '0.21');
          ring.setAttribute('color', 'white');
          ring.setAttribute('position', '0 0 0.001');
          ring.setAttribute('material', 'shader: flat; side: double; transparent: true; opacity: 1.0');

          clicked.appendChild(ring);
          window.currentQuestionSelections.push(val);
          return;
        }

      }



      function nextVideo() {
        console.log("â–¶ nextVideo() è¢«è°ƒç”¨ï¼Œcurrent =", window.current, "/", window.videos.length);
        current++;
        qIndex = 0;

        if (current < videos.length) {
          console.log("ğŸŸ£ æ’­æ”¾ä¸‹ä¸€ä¸ªè§†é¢‘:", videos[current]);
          playVideo(videos[current]);
        } else {
          console.log("ğŸŸ¢ æ‰€æœ‰è§†é¢‘æ’­æ”¾å®Œæ¯•ï¼Œå®éªŒç»“æŸ");
          // âœ… ä¿å­˜æ‰€æœ‰è¢«è¯•å›ç­”
          saveAnswersToFile();

          // âœ… å¯é€‰ï¼šæ˜¾ç¤ºæ„Ÿè°¢ç•Œé¢
          showEndScreen();
          
          endExperiment();
        }
      }

      // ====== æš´éœ²ç»™å…¨å±€ ======
      window.selectOption = selectOption;
      window.nextVideo = nextVideo;
      window.playVideo = playVideo;

      function endExperiment() {
        vrUI.setAttribute("visible", false);
        endBox.style.display = "block";
        console.log("âœ… å®éªŒç»“æŸï¼Œå›ç­”ç»“æœï¼š", answers);
      }
    

      // ====== ç¡®ä¿å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ ======
      // ====== ä¿è¯å…¨å±€å˜é‡åœ¨åŠ è½½åæ­£ç¡®åˆå§‹åŒ– ======
      window.addEventListener('DOMContentLoaded', () => {
        // å°†å‡½æ•°æŒ‚è½½åˆ°å…¨å±€
        window.selectOption = selectOption;
        window.nextVideo = nextVideo;
        window.playVideo = playVideo;

        // åˆå§‹åŒ–å…¨å±€çŠ¶æ€
        window.qIndex = 0;
        window.current = -1;
        window.questions = questions;
        window.videos = videos;

        console.log("âœ… å…¨å±€å˜é‡å·²åˆå§‹åŒ–ï¼š",
                    "qIndex=", window.qIndex,
                    "current=", window.current,
                    "questions=", window.questions.length,
                    "videos=", window.videos);
      });

      window.selectOption = selectOption;
      window.nextVideo = nextVideo;
      window.playVideo = playVideo;
      
      console.log("âœ… å…¨å±€å‡½æ•°å·²æš´éœ²ï¼š", window.selectOption, window.nextVideo, window.playVideo);
    
      // ======================================================
      // âœ… è‡ªåŠ¨ä¿å­˜è¢«è¯•é—®å·å›ç­”åˆ° JSON æ–‡ä»¶
      // ======================================================
      function saveAnswersToFile() {
        try {
          const filename = `responses_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;

          // æ•´ç†ç»“æœæ•°æ®
          const data = {
            timestamp: new Date().toLocaleString(),
            totalVideos: window.videos.length,
            totalQuestions: window.questions.length,
            answers: window.answers || []
          };

          console.log("ğŸŸ¢ [SAVE] æ­£åœ¨ä¿å­˜è¢«è¯•å›ç­”ï¼Œå…±", data.answers.length, "æ¡");
          console.log(JSON.stringify(data, null, 2));

          // åˆ›å»º Blob ä¸‹è½½æ–‡ä»¶
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          console.log("âœ… [SAVE] æ–‡ä»¶å·²ä¿å­˜:", filename);
        } catch (err) {
          console.error("âŒ [SAVE ERROR] ä¿å­˜å›ç­”å¤±è´¥:", err);
        }
      }

        // ======================================================
        // âœ… æ˜¾ç¤ºâ€œå®éªŒç»“æŸâ€ç•Œé¢
        // ======================================================
        function showEndScreen() {
          const scene = document.querySelector('a-scene');
          const endBox = document.createElement('a-entity');
          endBox.setAttribute('position', '0 2.2 -3');

          const text = document.createElement('a-text');
          text.setAttribute('value', 'å®éªŒç»“æŸï¼Œè°¢è°¢æ‚¨çš„å‚ä¸ï¼');
          text.setAttribute('align', 'center');
          text.setAttribute('color', '#00FFAA');
          text.setAttribute('width', '6');

          endBox.appendChild(text);
          scene.appendChild(endBox);

          console.log("ğŸ¬ æ˜¾ç¤ºæ„Ÿè°¢ç•Œé¢");
        }
    
    </script>
  </body>
</html>
