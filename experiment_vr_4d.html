<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>VR 全景声音实验（视频 + 休息提示 + 退出按钮）</title>

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>

    <style>
      body {
        margin: 0;
        background: #000;
        color: #fff;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          "PingFang SC", "Microsoft YaHei", sans-serif;
        overflow: hidden;
      }

      a-scene {
        position: fixed;
        inset: 0;
        z-index: 0;
      }

      /* 顶部开始提示框（只在网页模式下出现） */
      #startBox {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        top: 20px;
        max-width: 760px;
        width: min(760px, calc(100vw - 24px));
        background: rgba(0, 0, 0, 0.8);
        border-radius: 12px;
        padding: 16px 18px 18px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.45);
        text-align: center;
        z-index: 10;
        display: none;
      }

      #startBox h2 {
        margin: 0 0 10px 0;
        font-size: 20px;
      }

      #startBox p {
        margin: 0 0 12px 0;
        font-size: 14px;
        line-height: 1.4;
        opacity: 0.9;
      }

      #startBox button {
        font-size: 16px;
        padding: 8px 16px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        background: #ffffff;
        color: #000;
      }

      #startBox button:hover {
        background: #ff9800;
        color: #000;
      }

      /* 播放授权提示（只在网页模式下出现） */
      #tapToPlay {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        top: 20px;
        max-width: 480px;
        width: min(480px, calc(100vw - 24px));
        background: rgba(0, 0, 0, 0.8);
        border-radius: 12px;
        padding: 14px 16px 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.45);
        text-align: center;
        z-index: 11;
        display: none;
      }

      #tapToPlay h2 {
        margin: 0 0 8px 0;
        font-size: 18px;
      }

      #tapToPlay p {
        margin: 0 0 10px 0;
        font-size: 14px;
        opacity: 0.9;
      }

      #tapToPlay button {
        font-size: 16px;
        padding: 7px 14px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        background: #ffffff;
        color: #000;
      }

      #tapToPlay button:hover {
        background: #ff9800;
        color: #000;
      }

      /* 底部状态条（主要用于调试，可关） */
      #status {
        position: fixed;
        left: 12px;
        bottom: 12px;
        z-index: 12;
        background: rgba(0, 0, 0, 0.5);
        padding: 8px 10px;
        border-radius: 10px;
        max-width: min(520px, calc(100vw - 24px));
        font-size: 13px;
        line-height: 1.35;
        opacity: 0.9;
      }

      /* 网页模式下右上角的“退出 VR”按钮（沉浸退出后用） */
      #exitVrHtmlBtn {
        position: fixed;
        right: 12px;
        top: 12px;
        z-index: 12;
        padding: 8px 12px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        background: rgba(255, 255, 255, 0.92);
        color: #000;
        font-size: 14px;
      }

      #exitVrHtmlBtn:hover {
        background: #ff9800;
        color: #000;
      }

      /* 隐藏 video 元素本身，只用作纹理源 */
      #video {
        position: absolute;
        width: 1px;
        height: 1px;
        left: -9999px;
        top: -9999px;
        opacity: 0;
        pointer-events: none;
      }
    </style>
  </head>

  <body>
    <!-- A-Frame 场景 -->
    <a-scene
      id="scene"
      background="color: #000"
      renderer="antialias: true; colorManagement: true"
      vr-mode-ui="enabled: true"
    >
      <a-assets timeout="30000">
        <!-- 360 视频纹理 -->
        <video
          id="video"
          preload="auto"
          crossorigin="anonymous"
          playsinline
          webkit-playsinline
        ></video>

        <!-- Baseline 预留 MP3：未来你可以放 baseline.mp3 到同目录 -->
        <audio
          id="baselineAudio"
          crossorigin="anonymous"
        ></audio>
      </a-assets>

      <!-- 360 equirect 视频贴到球内侧 -->
      <a-videosphere
        id="sphere"
        src="#video"
        rotation="0 -90 0"
      ></a-videosphere>

      <!-- 相机 + 凝视光标 -->
      <a-entity id="rig" position="0 0 0">
        <a-camera id="camera" position="0 1.6 0" wasd-controls-enabled="false">
          <a-cursor
            id="cursor"
            fuse="true"
            fuse-timeout="800"
            raycaster="objects: .clickable"
            geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.018"
            material="color: #FFFF00; shader: flat"
          ></a-cursor>
        </a-camera>
      </a-entity>

      <!-- 休息提示面板（黑色界面 + 提示 + 倒计时 / 下一段提示 / 结束提示） -->
      <a-entity
        id="restPanel"
        position="0 1.6 -2"
        visible="false"
      >
        <a-plane
          id="restBg"
          width="2.2"
          height="1.4"
          color="#000000"
          opacity="0.98"
        ></a-plane>

        <!-- 主提示文本（英文，实际含义：请回答问题并休息） -->
        <a-text
          id="restMain"
          value="Please answer the questions and rest."
          align="center"
          color="#ffffff"
          width="2.0"
          position="0 0.3 0.02"
        ></a-text>

        <!-- 倒计时 / 辅助信息 -->
        <a-text
          id="restCountdown"
          value="45 s"
          align="center"
          color="#ffff00"
          width="1.5"
          position="0 0 0.02"
        ></a-text>
      </a-entity>

      <!-- 3D 退出按钮：脚下前方一点，文字用英文 Exit VR -->
      <a-entity id="exitBtn3D" position="0 0.9 -1.2" visible="false">
        <a-plane
          id="exitPlane"
          class="clickable"
          width="0.7"
          height="0.18"
          color="#ffffff"
          opacity="0.95"
        ></a-plane>
        <a-text
          value="Exit VR"
          align="center"
          color="#000000"
          width="0.9"
          position="0 0 0.02"
        ></a-text>
      </a-entity>
    </a-scene>

    <!-- 播放被浏览器阻止时的兜底层（只在网页模式下可见） -->
    <div id="tapToPlay">
      <h2>需要点击来开始播放</h2>
      <p>浏览器阻止了自动播放，请点击下面按钮以允许视频/声音播放。</p>
      <button id="tapPlayBtn">点此播放</button>
    </div>

    <!-- 开始提示（在网页模式下设置被试编号 & 开始实验） -->
    <div id="startBox">
      <h2>点击开始实验</h2>
      <p>
        页面会根据 <b>orders_30subs.json</b> 中的顺序播放视频；<br />
        每段视频结束后，VR 中会出现黑屏提示 + 45 秒倒计时；<br />
        期间请在网页上回答问卷，并根据需要休息。
      </p>
      <button id="startBtn">开始</button>
    </div>

    <!-- 网页模式下的“退出 VR”按钮（从沉浸退出后可用） -->
    <button id="exitVrHtmlBtn" onclick="document.querySelector('a-scene').exitVR();">
      退出沉浸
    </button>

    <!-- 底部状态条（调试用，可忽略） -->
    <div id="status">状态：等待加载 orders_30subs.json …</div>

    <script>
      /************* 0. 常量参数 *************/
      const ORDER_FILE = "orders_30subs.json";
      const BASELINE_MP3_DEFAULT = "baseline.mp3"; // 预留 Baseline 音频命名
      const REST_SECONDS = 45; // 每段视频后的黑屏休息时间（秒）
      const NEXT_WAIT_MS = 2000; // 显示“Next video (x/N)”的停留时间（毫秒）

      /************* 1. 状态变量 *************/
      let participantId = null;
      let ordersAll = null;
      let sequenceItems = [];
      let currentTrialIndex = -1; // 当前播放的是第几个（0-based）

      const sceneEl = document.getElementById("scene");
      const videoEl = document.getElementById("video");
      const sphereEl = document.getElementById("sphere");
      const baselineAudio = document.getElementById("baselineAudio");

      const startBox = document.getElementById("startBox");
      const startBtn = document.getElementById("startBtn");
      const tapToPlay = document.getElementById("tapToPlay");
      const tapPlayBtn = document.getElementById("tapPlayBtn");
      const statusEl = document.getElementById("status");

      const restPanel = document.getElementById("restPanel");
      const restMain = document.getElementById("restMain");
      const restCountdown = document.getElementById("restCountdown");
      const exitBtn3D = document.getElementById("exitBtn3D");
      const exitPlane = document.getElementById("exitPlane");

      let restTimerId = null;
      let restRemaining = 0;

      function setStatus(msg) {
        if (statusEl) statusEl.textContent = "状态：" + msg;
        console.log("[STATUS]", msg);
      }

      /************* 2. 工具函数：识别 Baseline MP3 *************/
      function isAudioItem(seqItem) {
        if (!seqItem || !seqItem.file) return false;
        return /\.mp3(\?|#|$)/i.test(seqItem.file.trim());
      }

      /************* 3. 播放控制（视频 / 音频） *************/
      function showTapToPlay(reason) {
        tapToPlay.style.display = "block";
        setStatus(
          (reason ? `需要点击授权播放（${reason}）` : "需要点击授权播放") + "。"
        );
      }

      function hideTapToPlay() {
        tapToPlay.style.display = "none";
      }

      async function tryPlayVideo(reason) {
        try {
          const p = videoEl.play();
          if (p && typeof p.then === "function") {
            await p;
          }
          hideTapToPlay();
          setStatus("播放中：" + (videoEl.currentSrc || videoEl.src || ""));
          return true;
        } catch (err) {
          console.warn("video play() 被阻止/失败:", err);
          showTapToPlay(reason || "play() 被阻止");
          return false;
        }
      }

      // 进入 VR 时尝试恢复视频播放
      sceneEl.addEventListener("enter-vr", () => {
        setStatus("已进入沉浸式模式（尝试恢复播放）…");
        tryPlayVideo("enter-vr");
      });

      // 从后台回到前台时尝试恢复视频播放
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) {
          tryPlayVideo("visibilitychange");
        }
      });

      tapPlayBtn.addEventListener("click", () => {
        hideTapToPlay();
        tryPlayVideo("tapToPlay");
      });

      /************* 4. 3D 退出按钮交互 *************/
      if (exitPlane) {
        exitPlane.addEventListener("mouseenter", () => {
          exitPlane.setAttribute("color", "#ff9800");
        });
        exitPlane.addEventListener("mouseleave", () => {
          exitPlane.setAttribute("color", "#ffffff");
        });
        exitPlane.addEventListener("click", () => {
          sceneEl.exitVR();
          setStatus("已请求退出沉浸式模式（Exit VR 按钮）。");
        });
      }

      /************* 5. 读取 orders_30subs.json + 选择被试编号 *************/
      async function initOrder() {
        try {
          setStatus("正在读取 " + ORDER_FILE + " …");
          const resp = await fetch(ORDER_FILE, { cache: "no-store" });
          const orders = await resp.json();
          if (!Array.isArray(orders) || orders.length === 0) {
            alert("orders_30subs.json 格式异常或为空。");
            setStatus("orders_30subs.json 格式异常或为空。");
            return;
          }
          ordersAll = orders;

          const maxPid = orders.length;
          let pidStr = prompt(
            `请输入被试编号（1 ~ ${maxPid} 之间的整数）：`
          );
          if (!pidStr) {
            alert("未输入编号，实验终止。");
            setStatus("未输入被试编号，已停止。");
            return;
          }
          const pid = parseInt(pidStr, 10);
          if (isNaN(pid) || pid < 1 || pid > maxPid) {
            alert(`编号无效：${pid}，必须在 1 ~ ${maxPid} 范围内。`);
            setStatus("被试编号无效：" + pid);
            return;
          }
          participantId = pid;

          const pObj =
            orders.find((item) => item.participant === pid) || orders[pid - 1];
          if (!pObj || !Array.isArray(pObj.sequence)) {
            alert("在 orders_30subs.json 中未找到该被试的 sequence。");
            setStatus("未找到该被试的 sequence。");
            return;
          }

          sequenceItems = pObj.sequence.slice();
          console.log("被试编号:", participantId);
          console.log("顺序:", sequenceItems.map((s) => s.file));

          startBox.style.display = "block";
          setStatus("顺序已加载（被试 " + participantId + "）。点击“开始”。");
        } catch (err) {
          console.error("读取 orders_30subs.json 失败:", err);
          alert("无法读取 orders_30subs.json，请检查文件是否和本页面在同一目录。");
          setStatus("读取 orders_30subs.json 失败。");
        }
      }

      window.addEventListener("load", initOrder);

      /************* 6. 主流程：开始实验 / 播放 trial *************/
      startBtn.addEventListener("click", () => {
        if (!sequenceItems || sequenceItems.length === 0) {
          alert("视频顺序尚未初始化，请刷新页面重试。");
          return;
        }
        startBox.style.display = "none";
        currentTrialIndex = 0;
        playTrial(currentTrialIndex);
      });

      function playTrial(index) {
        const total = sequenceItems.length;
        if (index < 0 || index >= total) {
          // 所有视频（或音频）已经播完
          showRestEnd();
          return;
        }
        currentTrialIndex = index;

        // 隐藏休息面板与退出按钮
        if (restPanel) restPanel.setAttribute("visible", false);
        if (exitBtn3D) exitBtn3D.setAttribute("visible", false);
        clearRestTimer();

        const seqItem = sequenceItems[index];
        const fileName = (seqItem.file || "").trim();

        if (!fileName) {
          console.warn("该 trial 没有 file 字段，直接跳到下一条:", seqItem);
          currentTrialIndex++;
          playTrial(currentTrialIndex);
          return;
        }

        if (isAudioItem(seqItem)) {
          playAudioTrial(seqItem, fileName);
        } else {
          playVideoTrial(seqItem, fileName);
        }
      }

      function playVideoTrial(seqItem, fileName) {
        try { baselineAudio.pause(); } catch (e) {}

        sphereEl.setAttribute("visible", true);

        try { videoEl.pause(); } catch (e) {}
        videoEl.removeAttribute("src");
        videoEl.load();

        videoEl.src = fileName;
        videoEl.load();

        setStatus("加载视频：" + fileName);

        videoEl.onerror = () => {
          alert(
            "无法加载视频文件： " +
              fileName +
              "\n请检查该 mp4 是否与 HTML 在同一文件夹，且文件名与 orders_30subs.json 中完全一致。"
          );
          setStatus("视频加载失败：" + fileName);
          console.error("❌ 视频加载失败:", fileName);
        };

        const onCanPlay = async () => {
          videoEl.removeEventListener("canplay", onCanPlay);
          try { videoEl.currentTime = 0; } catch (e) {}
          const ok = await tryPlayVideo("canplay");
          if (!ok) return;

          setStatus("开始播放视频：" + fileName);

          videoEl.onended = () => {
            setStatus("视频播放结束：" + fileName);
            handleTrialEnded();
          };
        };

        videoEl.addEventListener("canplay", onCanPlay, { once: false });
      }

      function playAudioTrial(seqItem, fileName) {
        // Baseline 音频：隐藏球体，黑屏播放 mp3，然后进入休息
        try { videoEl.pause(); } catch (e) {}
        sphereEl.setAttribute("visible", false);

        try { baselineAudio.pause(); } catch (e) {}
        baselineAudio.removeAttribute("src");
        baselineAudio.src = fileName;
        baselineAudio.load();

        setStatus("加载音频（baseline）：" + fileName);

        baselineAudio.onerror = () => {
          console.error("❌ Baseline 音频加载失败：", fileName);
          alert(
            "无法加载 baseline 音频： " +
              fileName +
              "\n请确认 mp3 文件与 HTML 在同一目录。"
          );
          // 即便失败，也直接进入休息阶段，避免流程卡死
          handleTrialEnded();
        };

        baselineAudio.onended = () => {
          setStatus("Baseline 音频播放结束：" + fileName);
          handleTrialEnded();
        };

        baselineAudio.play().catch((err) => {
          console.warn("Baseline 音频 play() 被阻止/失败:", err);
          // 如果播放失败，同样直接进入休息阶段
          handleTrialEnded();
        });
      }

      function handleTrialEnded() {
        // 每个 trial（视频或音频）结束后：黑屏 + 提示 + 45 秒倒计时
        showRestCountdown();
      }

      /************* 7. 休息面板逻辑（黑屏 + 倒计时 + Next 文字） *************/
      function clearRestTimer() {
        if (restTimerId !== null) {
          clearInterval(restTimerId);
          restTimerId = null;
        }
      }

      function showRestCountdown() {
        // 暂停视频 / 音频，黑屏
        try { videoEl.pause(); } catch (e) {}
        try { baselineAudio.pause(); } catch (e) {}
        sphereEl.setAttribute("visible", false);

        if (!restPanel || !restMain || !restCountdown) return;

        restRemaining = REST_SECONDS;
        // 这里对应你说的“请回答问题，并休息”
        restMain.setAttribute(
          "value",
          "Please answer the questions and rest."
        );
        restCountdown.setAttribute("value", `${restRemaining} s`);

        restPanel.setAttribute("visible", true);
        if (exitBtn3D) exitBtn3D.setAttribute("visible", true);

        clearRestTimer();
        restTimerId = setInterval(() => {
          restRemaining -= 1;
          if (restRemaining <= 0) {
            clearRestTimer();
            restCountdown.setAttribute("value", "");
            showRestNextOrEnd();
          } else {
            restCountdown.setAttribute("value", `${restRemaining} s`);
          }
        }, 1000);
      }

      function showRestNextOrEnd() {
        const total = sequenceItems.length;
        const nextIndex = currentTrialIndex + 1;

        if (!restPanel || !restMain || !restCountdown) return;

        if (nextIndex < total) {
          // 还有下一段：显示“即将播放下一段视频（2/21）”
          const label = `${nextIndex + 1}/${total}`;
          restMain.setAttribute(
            "value",
            `Next video (${label}) will start.`
          );
          restCountdown.setAttribute("value", "");

          // 稍等片刻后开始下一段
          setTimeout(() => {
            restPanel.setAttribute("visible", false);
            if (exitBtn3D) exitBtn3D.setAttribute("visible", false);
            playTrial(nextIndex);
          }, NEXT_WAIT_MS);
        } else {
          // 没有下一段：实验结束
          showRestEnd();
        }
      }

      function showRestEnd() {
        try { videoEl.pause(); } catch (e) {}
        try { baselineAudio.pause(); } catch (e) {}
        sphereEl.setAttribute("visible", false);
        clearRestTimer();

        if (!restPanel || !restMain || !restCountdown) return;

        // 这里对应你说的“试验结束”
        restMain.setAttribute("value", "Experiment finished.");
        restCountdown.setAttribute("value", "");
        restPanel.setAttribute("visible", true);
        if (exitBtn3D) exitBtn3D.setAttribute("visible", true);

        setStatus("所有 trial 播放完成，实验结束。");
      }
    </script>
  </body>
</html>
