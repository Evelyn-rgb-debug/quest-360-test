<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>VR 全景声音实验（Quest 360 + orders_30subs）</title>

    <!-- A-Frame（与你测试页一致：1.7.0） -->
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>

    <style>
      body {
        margin: 0;
        background: #000;
        color: #fff;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          "PingFang SC", "Microsoft YaHei", sans-serif;
        overflow: hidden;
      }

      /* A-Frame 全屏 */
      a-scene {
        position: fixed;
        inset: 0;
        z-index: 0;
      }

      /* UI 覆盖层 */
      #startBox,
      #questionBox,
      #endBox,
      #tapToPlay {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        top: 18px;
        max-width: 760px;
        width: min(760px, calc(100vw - 24px));
        background: rgba(0, 0, 0, 0.72);
        border-radius: 12px;
        padding: 16px 18px 18px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.45);
        text-align: center;
        z-index: 10;
      }

      #startBox {
        display: none; /* 等顺序加载好再显示 */
      }
      #questionBox,
      #endBox,
      #tapToPlay {
        display: none;
      }

      #startBox h2,
      #endBox h2 {
        margin: 0 0 10px 0;
        font-size: 20px;
      }

      #questionBox h3 {
        margin: 6px 0 12px 0;
        font-size: 19px;
        line-height: 1.35;
      }

      #progress,
      #status {
        font-size: 13px;
        opacity: 0.85;
        margin-bottom: 8px;
      }

      #status {
        position: fixed;
        left: 12px;
        bottom: 12px;
        z-index: 12;
        background: rgba(0, 0, 0, 0.5);
        padding: 8px 10px;
        border-radius: 10px;
        max-width: min(520px, calc(100vw - 24px));
        line-height: 1.35;
      }

      #options {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
        margin-top: 6px;
      }

      button {
        font-size: 16px;
        padding: 8px 14px;
        margin: 4px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        background: #ffffff;
        color: #000;
        white-space: nowrap;
      }

      button:hover {
        background: #ff9800;
        color: #000;
      }

      /* 让 video 元素不占页面（只当作纹理源） */
      #video {
        position: absolute;
        width: 1px;
        height: 1px;
        left: -9999px;
        top: -9999px;
        opacity: 0;
        pointer-events: none;
      }

      /* Baseline 黑屏提示层 */
      #baselineOverlay {
        position: fixed;
        inset: 0;
        background: #000;
        color: #fff;
        display: none;
        z-index: 9999;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 24px;
      }
      #baselineOverlay .title {
        font-size: 52px;
        margin-bottom: 10px;
        letter-spacing: 1px;
      }
      #baselineOverlay .subtitle {
        font-size: 22px;
        opacity: 0.75;
        line-height: 1.4;
      }
    </style>
  </head>

  <body>
    <!-- A-Frame 场景：负责 360° 视频渲染 -->
    <a-scene
      id="scene"
      background="color: #000"
      renderer="antialias: true; colorManagement: true"
      vr-mode-ui="enabled: true"
    >
      <a-assets timeout="30000">
        <video
          id="video"
          preload="auto"
          crossorigin="anonymous"
          playsinline
          webkit-playsinline
        ></video>
      </a-assets>

      <a-videosphere
        id="sphere"
        src="#video"
        rotation="0 -90 0"
      ></a-videosphere>

      <a-camera position="0 1.6 0"></a-camera>
    </a-scene>

    <!-- 播放被阻止时的兜底（Quest / 移动端很常见） -->
    <div id="tapToPlay">
      <h2 style="margin: 0 0 8px 0;">需要一次点击来开始播放</h2>
      <p style="margin: 0 0 10px 0; opacity: 0.85;">
        请点击下面按钮以允许视频/声音播放（浏览器的权限限制）。
      </p>
      <button id="tapPlayBtn">点此播放</button>
    </div>

    <!-- 开始提示 -->
    <div id="startBox">
      <h2>点击开始实验</h2>
      <p style="margin-top: 4px; margin-bottom: 10px; opacity: 0.9;">
        页面将先播放 <b>videodemo.mp4</b> 作为演示（不出题），随后进入正式实验；每段视频结束后会弹出 4 个问题。
      </p>
      <button id="startBtn">开始</button>
    </div>

    <!-- 问卷弹窗 -->
    <div id="questionBox">
      <div id="progress"></div>
      <h3 id="questionText"></h3>
      <div id="options"></div>
    </div>

    <!-- 结束提示 -->
    <div id="endBox">
      <h2>实验结束，谢谢参与！</h2>
      <p style="margin-top: 4px; margin-bottom: 6px; opacity: 0.9;">
        你可以关闭页面，本次实验数据会自动下载为 JSON 文件。
      </p>
    </div>

    <!-- Baseline 黑屏提示层（“请闭眼”） -->
    <div id="baselineOverlay">
      <div>
        <div class="title">请闭眼</div>
        <div class="subtitle">请保持不动，等待声音播放</div>
      </div>
    </div>

    <div id="status">状态：等待加载 orders_30subs.json …</div>

    <script>
      /************* 0. 参数 *************/
      const ORDER_FILE = "orders_30subs.json";
      const ENABLE_DEMO = true;
      const DEMO_FILE = "videodemo.mp4"; // 需放在与 HTML 同目录
      const DEMO_ITEM = {
        block: "DEMO",
        clip: "videodemo",
        file: DEMO_FILE,
        isDemo: true,
        skipQuestions: true
      };

      /************* 1. 问卷配置 *************/
      const questions = [
        {
          key: "dominance",
          text: "无人机声音在整体声环境中的主导程度有多大？",
          options: [
            "1 = 完全不主导",
            "2 = 略微主导",
            "3 = 中等主导",
            "4 = 非常主导",
            "5 = 完全主导"
          ]
        },
        {
          key: "loudness",
          text: "无人机声音响度如何？",
          options: [
            "1 = 非常安静",
            "2 = 略微响",
            "3 = 中等响",
            "4 = 非常响",
            "5 = 极其响"
          ]
        },
        {
          key: "annoyance",
          text: "无人机声音烦扰度如何？",
          options: [
            "1 = 完全不烦扰",
            "2 = 略微烦扰",
            "3 = 中等烦扰",
            "4 = 非常烦扰",
            "5 = 极其烦扰"
          ]
        },
        {
          key: "acceptability",
          text:
            "如果这种声音在你居住区或街道中经常出现，你会觉得它有多可接受？",
          options: [
            "1 = 不可接受",
            "2 = 勉强可接受",
            "3 = 中立",
            "4 = 可接受",
            "5 = 非常可接受"
          ]
        }
      ];

      /************* 2. 状态变量 *************/
      let participantId = null;
      let ordersAll = null;
      let sequenceItems = []; // 来自 orders_30subs.json 的 sequence 数组（可能前面插入 demo）
      let videos = []; // 仅文件名数组，便于显示进度
      let currentVideoIndex = -1;
      let currentQuestionIndex = 0;
      let baselineTimer = null;
      const answers = [];

      const sceneEl = document.getElementById("scene");
      const sphereEl = document.getElementById("sphere");
      const videoEl = document.getElementById("video");

      const startBox = document.getElementById("startBox");
      const questionBox = document.getElementById("questionBox");
      const endBox = document.getElementById("endBox");
      const tapToPlay = document.getElementById("tapToPlay");
      const tapPlayBtn = document.getElementById("tapPlayBtn");
      const baselineOverlay = document.getElementById("baselineOverlay");
      const questionTextEl = document.getElementById("questionText");
      const optionsEl = document.getElementById("options");
      const progressEl = document.getElementById("progress");
      const statusEl = document.getElementById("status");
      const startBtn = document.getElementById("startBtn");

      function setStatus(msg) {
        if (statusEl) statusEl.textContent = "状态：" + msg;
        console.log("[STATUS]", msg);
      }

      /************* 3. 关键：保证视频在 Quest 可播放 *************/
      function showTapToPlay(reason) {
        tapToPlay.style.display = "block";
        setStatus(
          (reason ? `需要点击授权播放（${reason}）` : "需要点击授权播放") +
            "。"
        );
      }
      function hideTapToPlay() {
        tapToPlay.style.display = "none";
      }

      async function tryPlay(reason) {
        try {
          const p = videoEl.play();
          if (p && typeof p.then === "function") {
            await p;
          }
          hideTapToPlay();
          setStatus("播放中：" + (videoEl.currentSrc || videoEl.src || ""));
          return true;
        } catch (err) {
          console.warn("play() 被阻止/失败:", err);
          showTapToPlay(reason || "play() 被阻止");
          return false;
        }
      }

      // 进入 VR 时，有时视频会被浏览器暂停；在 enter-vr 事件里再触发一次 play()
      sceneEl.addEventListener("enter-vr", () => {
        setStatus("已进入 VR（尝试恢复播放）…");
        // enter-vr 本身也是一次用户手势触发的动作，通常允许播放
        tryPlay("enter-vr");
      });

      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) {
          // 回到前台后尝试恢复
          tryPlay("visibilitychange");
        }
      });

      tapPlayBtn.addEventListener("click", () => {
        hideTapToPlay();
        tryPlay("tapToPlay");
      });

      /************* 4. 读取 orders_30subs.json + 输入被试编号 *************/
      async function initOrder() {
        try {
          setStatus("正在读取 " + ORDER_FILE + " …");
          const resp = await fetch(ORDER_FILE, { cache: "no-store" });
          const orders = await resp.json(); // 顶层是数组
          ordersAll = orders;

          let pid = prompt(
            `请输入被试编号（1 ~ ${orders.length} 之间的整数）：`
          );
          if (!pid) {
            alert("未输入编号，实验终止。");
            setStatus("未输入被试编号，已停止。");
            return;
          }
          pid = parseInt(pid, 10);
          if (isNaN(pid) || pid < 1 || pid > orders.length) {
            alert(`编号无效：${pid}，必须在 1 ~ ${orders.length} 范围内。`);
            setStatus("被试编号无效：" + pid);
            return;
          }
          participantId = pid;

          const pObj =
            orders.find((item) => item.participant === pid) || orders[pid - 1];
          if (!pObj || !Array.isArray(pObj.sequence)) {
            alert("在 orders_30subs.json 中未找到该被试的 sequence。");
            setStatus("未找到该被试的 sequence。");
            return;
          }

          sequenceItems = pObj.sequence.slice();

          // 头部插入 demo（不出题）
          if (ENABLE_DEMO) {
            sequenceItems.unshift({ ...DEMO_ITEM });
          }

          videos = sequenceItems.map((item) => (item.file || "").trim() || "BASELINE");

          console.log("被试编号:", participantId);
          console.log("视频顺序:", videos);

          startBox.style.display = "block";
          setStatus("顺序已加载（被试 " + participantId + "）。等待开始。");
        } catch (err) {
          console.error("读取 orders_30subs.json 失败:", err);
          alert("无法读取 orders_30subs.json，请检查文件是否和本页面在同一目录。");
          setStatus("读取 orders_30subs.json 失败。");
        }
      }

      window.addEventListener("load", initOrder);

      /************* 5. Baseline 逻辑 *************/
      function isBaselineItem(seqItem) {
        if (!seqItem) return false;
        if (seqItem.isBaseline === true) return true;
        if (
          typeof seqItem.type === "string" &&
          seqItem.type.toLowerCase() === "baseline"
        ) {
          return true;
        }
        const file = (seqItem.file || "").trim();
        if (!file) return true;
        return /(^|\/)(baseline|black|blank)(_|-|\.|$)/i.test(file);
      }

      function showBaselineOverlay(
        title = "请闭眼",
        subtitle = "请保持不动，等待声音播放"
      ) {
        const titleEl = baselineOverlay.querySelector(".title");
        const subEl = baselineOverlay.querySelector(".subtitle");
        if (titleEl) titleEl.textContent = title;
        if (subEl) subEl.textContent = subtitle;
        baselineOverlay.style.display = "flex";
      }

      function hideBaselineOverlay() {
        baselineOverlay.style.display = "none";
      }

      function runBaseline(seqItem) {
        questionBox.style.display = "none";
        endBox.style.display = "none";
        hideTapToPlay();

        // 暂停视频并隐藏球体，避免残留画面
        try { videoEl.pause(); } catch (e) {}
        sphereEl.setAttribute("visible", "false");

        if (baselineTimer) {
          clearTimeout(baselineTimer);
          baselineTimer = null;
        }

        const durationSec = Number(
          seqItem?.durationSec ?? seqItem?.baselineDurationSec ?? 10
        );
        const title = seqItem?.baselineTitle || "请闭眼";
        const subtitle = seqItem?.baselineSubtitle || "请保持不动，等待声音播放";
        showBaselineOverlay(title, subtitle);

        setStatus(`Baseline：${Math.max(1, durationSec)} 秒`);
        baselineTimer = setTimeout(() => {
          hideBaselineOverlay();
          sphereEl.setAttribute("visible", "true");
          currentQuestionIndex = 0;
          showQuestion();
        }, Math.max(1, durationSec) * 1000);
      }

      /************* 6. 主流程 *************/
      startBtn.addEventListener("click", () => startExperiment());

      function startExperiment() {
        if (!sequenceItems || sequenceItems.length === 0) {
          alert("视频顺序尚未初始化，请刷新页面重试。");
          return;
        }
        startBox.style.display = "none";
        currentVideoIndex = 0;
        playTrial(currentVideoIndex);
      }

      function playTrial(index) {
        if (index < 0 || index >= sequenceItems.length) {
          endExperiment();
          return;
        }

        if (baselineTimer) {
          clearTimeout(baselineTimer);
          baselineTimer = null;
        }
        hideBaselineOverlay();
        hideTapToPlay();

        const seqItem = sequenceItems[index];

        if (isBaselineItem(seqItem) && !seqItem.isDemo) {
          runBaseline(seqItem);
        } else {
          playVideo(seqItem);
        }
      }

      // 播放视频（关键：load + canplay 再 play，避免 Quest 上“只显示第一帧”）
      function playVideo(seqItem) {
        questionBox.style.display = "none";
        endBox.style.display = "none";

        sphereEl.setAttribute("visible", "true");

        const fileName = (seqItem.file || "").trim();
        if (!fileName) {
          // 空文件名也当 baseline
          runBaseline(seqItem);
          return;
        }

        // 清理旧监听
        videoEl.onended = null;
        videoEl.onerror = null;

        // 重新设置 src
        try { videoEl.pause(); } catch (e) {}
        videoEl.removeAttribute("src"); // 某些浏览器更稳
        videoEl.load();

        videoEl.src = fileName;
        videoEl.load();

        setStatus("加载视频：" + fileName);

        videoEl.onerror = () => {
          alert(
            "无法加载视频文件： " +
              fileName +
              "。\n请检查该 mp4 是否与 HTML 在同一文件夹，且文件名与 orders_30subs.json 中完全一致。"
          );
          setStatus("视频加载失败：" + fileName);
          console.error("❌ 视频加载失败:", fileName);
        };

        const onCanPlay = async () => {
          // 只触发一次
          videoEl.removeEventListener("canplay", onCanPlay);

          try {
            videoEl.currentTime = 0;
          } catch (e) {}

          const ok = await tryPlay("canplay");
          if (!ok) return;

          videoEl.onended = () => {
            setStatus("播放结束：" + fileName);

            // Demo：不出题，自动进入下一段
            if (seqItem.skipQuestions) {
              currentVideoIndex++;
              if (currentVideoIndex >= sequenceItems.length) {
                endExperiment();
              } else {
                playTrial(currentVideoIndex);
              }
              return;
            }

            currentQuestionIndex = 0;
            showQuestion();
          };
        };

        // canplay 有时不触发，补一个 loadeddata
        videoEl.addEventListener("canplay", onCanPlay, { once: false });
        videoEl.addEventListener(
          "loadeddata",
          () => {
            // 如果 canplay 没来，也尝试
            tryPlay("loadeddata");
          },
          { once: true }
        );
      }

      function showQuestion() {
        const q = questions[currentQuestionIndex];

        const videoLabel = `${currentVideoIndex + 1} / ${videos.length}`;
        const questionLabel = `${currentQuestionIndex + 1} / ${questions.length}`;
        progressEl.textContent = `视频 ${videoLabel} · 问题 ${questionLabel}`;
        questionTextEl.textContent = q.text;

        optionsEl.innerHTML = "";
        q.options.forEach((optText, idx) => {
          const btn = document.createElement("button");
          btn.textContent = optText;
          const numericValue = idx + 1;
          btn.onclick = () => handleAnswer(optText, numericValue);
          optionsEl.appendChild(btn);
        });

        questionBox.style.display = "block";
      }

      function handleAnswer(optionText, numericValue) {
        const seqItem = sequenceItems[currentVideoIndex];
        const q = questions[currentQuestionIndex];

        answers.push({
          participantId,
          sequenceIndex: currentVideoIndex,
          block: seqItem.block || null,
          clip: seqItem.clip || null,
          videoTag: seqItem.video || null,
          snr: seqItem.snr || null,
          file: seqItem.file || null,
          questionIndex: currentQuestionIndex,
          questionKey: q.key,
          questionText: q.text,
          value: numericValue,
          label: optionText,
          timestamp: new Date().toISOString()
        });

        currentQuestionIndex++;
        if (currentQuestionIndex < questions.length) {
          showQuestion();
        } else {
          questionBox.style.display = "none";
          currentVideoIndex++;
          if (currentVideoIndex >= videos.length) {
            endExperiment();
          } else {
            playTrial(currentVideoIndex);
          }
        }
      }

      function endExperiment() {
        setStatus("实验结束，准备导出 JSON …");
        endBox.style.display = "block";
        setTimeout(downloadAnswers, 500);
      }

      function downloadAnswers() {
        const payload = {
          participantId,
          videos,
          sequence: sequenceItems,
          questions,
          answers,
          finishedAt: new Date().toISOString(),
          sourceOrderFile: ORDER_FILE
        };

        const blob = new Blob([JSON.stringify(payload, null, 2)], {
          type: "application/json"
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const timestamp = new Date()
          .toISOString()
          .replace(/[:.]/g, "-")
          .slice(0, 19);
        a.href = url;
        a.download = `vr_answers_pid${participantId || "NA"}_${timestamp}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        setStatus("已触发下载：" + a.download);
      }
    </script>
  </body>
</html>
