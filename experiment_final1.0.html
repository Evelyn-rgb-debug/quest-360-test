<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>VR å…¨æ™¯å£°éŸ³å®éªŒï¼ˆorders_30subs ç‰ˆæœ¬ï¼‰</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style>
      body {
        margin: 0;
        background: #000;
        color: #fff;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          "PingFang SC", "Microsoft YaHei", sans-serif;
      }

      #startBox,
      #questionBox,
      #endBox {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        top: 30px;
        max-width: 760px;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 12px;
        padding: 18px 22px 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        text-align: center;
        z-index: 10;
      }

      #startBox h2,
      #endBox h2 {
        margin: 0 0 10px 0;
        font-size: 22px;
      }

      #startBox {
        display: none; /* ç­‰é¡ºåºåŠ è½½å¥½å†æ˜¾ç¤º */
      }

      #questionBox h3 {
        margin: 6px 0 12px 0;
        font-size: 20px;
        line-height: 1.35;
      }

      #questionBox,
      #endBox {
        display: none;
      }

      #progress {
        font-size: 13px;
        opacity: 0.85;
        margin-bottom: 8px;
      }

      #options {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
        margin-top: 6px;
      }

      button {
        font-size: 16px;
        padding: 8px 14px;
        margin: 4px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        background: #ffffff;
        color: #000;
        white-space: nowrap;
      }

      button:hover {
        background: #ff9800;
        color: #000;
      }
    </style>
  </head>

  <body>
    <!-- è§†é¢‘èµ„æºï¼ˆç»™ A-Frame ç”¨ï¼‰ -->
    <video
      id="video"
      crossorigin="anonymous"
      webkit-playsinline
      playsinline
      controls
    ></video>

    <!-- A-Frame åœºæ™¯ï¼šåªè´Ÿè´£ 360Â° è§†é¢‘ -->
    <a-scene>
      <a-videosphere id="sphere" src="#video" rotation="0 -90 0"></a-videosphere>
      <a-camera position="0 0 0"></a-camera>
    </a-scene>

    <!-- å¼€å§‹æç¤º -->
    <div id="startBox">
      <h2>ç‚¹å‡»å¼€å§‹å®éªŒ</h2>
      <p style="margin-top: 4px; margin-bottom: 10px;">
        æ¯æ®µå…¨æ™¯è§†é¢‘æ’­æ”¾ç»“æŸåï¼Œä¼šå¼¹å‡º 4 ä¸ªé—®é¢˜ï¼Œè¯·æ ¹æ®ä½ åˆšåˆšå¬åˆ°çš„å£°éŸ³æŒ‰é¡ºåºä½œç­”ã€‚
      </p>
      <button onclick="startExperiment()">å¼€å§‹</button>
    </div>

    <!-- é—®å·å¼¹çª— -->
    <div id="questionBox">
      <div id="progress"></div>
      <h3 id="questionText"></h3>
      <div id="options"></div>
    </div>

    <!-- ç»“æŸæç¤º -->
    <div id="endBox">
      <h2>å®éªŒç»“æŸï¼Œè°¢è°¢å‚ä¸ï¼</h2>
      <p style="margin-top: 4px; margin-bottom: 6px;">
        ä½ å¯ä»¥å…³é—­é¡µé¢ï¼Œæœ¬æ¬¡å®éªŒæ•°æ®ä¼šè‡ªåŠ¨ä¸‹è½½ä¸º JSON æ–‡ä»¶ã€‚
      </p>
    </div>

    <script>
      /************* 0. é—®å·é—®é¢˜é…ç½® *************/

      const questions = [
        {
          key: "dominance",
          text: "æ— äººæœºå£°éŸ³åœ¨æ•´ä½“å£°ç¯å¢ƒä¸­çš„ä¸»å¯¼ç¨‹åº¦æœ‰å¤šå¤§ï¼Ÿ",
          options: [
            "1 = å®Œå…¨ä¸ä¸»å¯¼",
            "2 = ç•¥å¾®ä¸»å¯¼",
            "3 = ä¸­ç­‰ä¸»å¯¼",
            "4 = éå¸¸ä¸»å¯¼",
            "5 = å®Œå…¨ä¸»å¯¼"
          ]
        },
        {
          key: "loudness",
          text: "æ— äººæœºå£°éŸ³å“åº¦å¦‚ä½•ï¼Ÿ",
          options: [
            "1 = éå¸¸å®‰é™",
            "2 = ç•¥å¾®å“",
            "3 = ä¸­ç­‰å“",
            "4 = éå¸¸å“",
            "5 = æå…¶å“"
          ]
        },
        {
          key: "annoyance",
          text: "æ— äººæœºå£°éŸ³çƒ¦æ‰°åº¦å¦‚ä½•ï¼Ÿ",
          options: [
            "1 = å®Œå…¨ä¸çƒ¦æ‰°",
            "2 = ç•¥å¾®çƒ¦æ‰°",
            "3 = ä¸­ç­‰çƒ¦æ‰°",
            "4 = éå¸¸çƒ¦æ‰°",
            "5 = æå…¶çƒ¦æ‰°"
          ]
        },
        {
          key: "acceptability",
          text:
            "å¦‚æœè¿™ç§å£°éŸ³åœ¨ä½ å±…ä½åŒºæˆ–è¡—é“ä¸­ç»å¸¸å‡ºç°ï¼Œä½ ä¼šè§‰å¾—å®ƒæœ‰å¤šå¯æ¥å—ï¼Ÿ",
          options: [
            "1 = ä¸å¯æ¥å—",
            "2 = å‹‰å¼ºå¯æ¥å—",
            "3 = ä¸­ç«‹",
            "4 = å¯æ¥å—",
            "5 = éå¸¸å¯æ¥å—"
          ]
        }
      ];

      /************* 1. çŠ¶æ€å˜é‡ *************/

      let participantId = null;
      let sequenceItems = []; // æ¥è‡ª orders_30subs.json çš„ sequence æ•°ç»„
      let videos = []; // ä»…æ–‡ä»¶åæ•°ç»„ï¼Œä¾¿äºæ˜¾ç¤ºè¿›åº¦
      let currentVideoIndex = -1;
      let currentQuestionIndex = 0;
      const answers = [];

      const videoEl = document.getElementById("video");
      const startBox = document.getElementById("startBox");
      const questionBox = document.getElementById("questionBox");
      const endBox = document.getElementById("endBox");
      const questionTextEl = document.getElementById("questionText");
      const optionsEl = document.getElementById("options");
      const progressEl = document.getElementById("progress");

      /************* 2. è¯»å– orders_30subs.json + è¾“å…¥è¢«è¯•ç¼–å· *************/

      async function initOrder() {
        try {
          const resp = await fetch("orders_30subs.json");
          const orders = await resp.json(); // é¡¶å±‚æ˜¯æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ å¯¹åº”ä¸€ä¸ª participant

          let pid = prompt(
            `è¯·è¾“å…¥è¢«è¯•ç¼–å·ï¼ˆ1 ~ ${orders.length} ä¹‹é—´çš„æ•´æ•°ï¼‰ï¼š`
          );
          if (!pid) {
            alert("æœªè¾“å…¥ç¼–å·ï¼Œå®éªŒç»ˆæ­¢ã€‚");
            return;
          }
          pid = parseInt(pid, 10);
          if (isNaN(pid) || pid < 1 || pid > orders.length) {
            alert(`ç¼–å·æ— æ•ˆï¼š${pid}ï¼Œå¿…é¡»åœ¨ 1 ~ ${orders.length} èŒƒå›´å†…ã€‚`);
            return;
          }
          participantId = pid;

          // æ‰¾åˆ°å¯¹åº” participant å¯¹è±¡ï¼ˆæ›´ç¨³å¦¥ï¼Œè€Œä¸æ˜¯ç›´æ¥ orders[pid-1]ï¼‰
          const pObj =
            orders.find((item) => item.participant === pid) || orders[pid - 1];
          if (!pObj || !Array.isArray(pObj.sequence)) {
            alert("åœ¨ orders_30subs.json ä¸­æœªæ‰¾åˆ°è¯¥è¢«è¯•çš„ sequenceã€‚");
            return;
          }

          sequenceItems = pObj.sequence; // æ¯ä¸ªå…ƒç´ å½¢å¦‚ {block, clip/video/snr, file: "..."}
          videos = sequenceItems.map((item) => item.file);

          console.log("è¢«è¯•ç¼–å·:", participantId);
          console.log("è§†é¢‘é¡ºåº:", videos);

          startBox.style.display = "block";
          alert(
            `è¢«è¯• ${participantId} çš„è§†é¢‘é¡ºåºå·²åŠ è½½ï¼š\n` + videos.join(", ")
          );
        } catch (err) {
          console.error("è¯»å– orders_30subs.json å¤±è´¥:", err);
          alert("æ— æ³•è¯»å– orders_30subs.jsonï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å’Œæœ¬é¡µé¢åœ¨åŒä¸€ç›®å½•ã€‚");
        }
      }

      window.addEventListener("load", initOrder);

      /************* 3. ä¸»æµç¨‹ï¼šæ’­æ”¾è§†é¢‘ & å››é¢˜é—®å· *************/

      function startExperiment() {
        if (!videos || videos.length === 0) {
          alert("è§†é¢‘é¡ºåºå°šæœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚");
          return;
        }
        startBox.style.display = "none";
        currentVideoIndex = 0;
        playVideo(videos[currentVideoIndex]);
      }

      function playVideo(fileName) {
        questionBox.style.display = "none";
        endBox.style.display = "none";

        videoEl.src = fileName;

        // ä»ç„¶ä¿ç•™â€œæ‰¾ä¸åˆ°æ–‡ä»¶â€çš„æç¤º
        videoEl.onerror = () => {
            alert(
            "æ— æ³•åŠ è½½è§†é¢‘æ–‡ä»¶ï¼š " +
                fileName +
                "ã€‚\nè¯·æ£€æŸ¥è¯¥ mp4 æ˜¯å¦ä¸ HTML åœ¨åŒä¸€æ–‡ä»¶å¤¹ï¼Œä¸”æ–‡ä»¶åä¸ orders_30subs.json ä¸­å®Œå…¨ä¸€è‡´ã€‚"
            );
            console.error("âŒ è§†é¢‘åŠ è½½å¤±è´¥:", fileName);
        };

        const p = videoEl.play();
        if (p && typeof p.then === "function") {
            p.catch((err) => {
            // è¿™é‡Œä¸å†å¼¹çª—ï¼Œåªåœ¨æ§åˆ¶å°é‡Œè®°ä¸€ç¬”
            console.warn("è‡ªåŠ¨æ’­æ”¾å¯èƒ½è¢«æµè§ˆå™¨é˜»æ­¢:", err);
            // ä¸åšä»»ä½• UI æç¤ºï¼Œè®©é¡µé¢ä¿æŒå®‰é™
            });
        }

        console.log("â–¶ æ’­æ”¾è§†é¢‘:", fileName);

        videoEl.onended = () => {
            console.log("ğŸ“º æ’­æ”¾ç»“æŸ:", fileName);
            currentQuestionIndex = 0;
            showQuestion();
        };
      }


      function showQuestion() {
        const q = questions[currentQuestionIndex];

        const videoLabel = `${currentVideoIndex + 1} / ${videos.length}`;
        const questionLabel = `${currentQuestionIndex + 1} / ${
          questions.length
        }`;
        progressEl.textContent = `è§†é¢‘ ${videoLabel} Â· é—®é¢˜ ${questionLabel}`;
        questionTextEl.textContent = q.text;

        optionsEl.innerHTML = "";
        q.options.forEach((optText, idx) => {
          const btn = document.createElement("button");
          btn.textContent = optText;
          const numericValue = idx + 1;
          btn.onclick = () => handleAnswer(optText, numericValue);
          optionsEl.appendChild(btn);
        });

        questionBox.style.display = "block";
      }

      function handleAnswer(optionText, numericValue) {
        const seqItem = sequenceItems[currentVideoIndex];
        const q = questions[currentQuestionIndex];

        answers.push({
          participantId,
          sequenceIndex: currentVideoIndex,
          // æ¥è‡ª orders_30subs.json çš„å…ƒæ•°æ®ï¼ˆä¸åŒå…ƒç´ å¯èƒ½åªæœ‰éƒ¨åˆ†å­—æ®µï¼‰
          block: seqItem.block || null,
          clip: seqItem.clip || null,
          videoTag: seqItem.video || null,
          snr: seqItem.snr || null,
          file: seqItem.file,
          questionIndex: currentQuestionIndex,
          questionKey: q.key,
          questionText: q.text,
          value: numericValue,
          label: optionText,
          timestamp: new Date().toISOString()
        });

        console.log("âœ… è®°å½•ç­”æ¡ˆ:", answers[answers.length - 1]);

        currentQuestionIndex++;
        if (currentQuestionIndex < questions.length) {
          showQuestion();
        } else {
          // å½“å‰è§†é¢‘å››é¢˜ç»“æŸ
          questionBox.style.display = "none";
          currentVideoIndex++;
          if (currentVideoIndex >= videos.length) {
            endExperiment();
          } else {
            playVideo(videos[currentVideoIndex]);
          }
        }
      }

      function endExperiment() {
        console.log("ğŸ¯ å®éªŒç»“æŸï¼Œå…¨éƒ¨ç­”æ¡ˆ:", answers);
        endBox.style.display = "block";

        // å®éªŒç»“æŸåè‡ªåŠ¨ä¸‹è½½ JSON
        setTimeout(downloadAnswers, 500);
      }

      /************* 4. è‡ªåŠ¨å¯¼å‡º JSON *************/

      function downloadAnswers() {
        const payload = {
          participantId,
          videos,
          sequence: sequenceItems,
          questions,
          answers,
          finishedAt: new Date().toISOString(),
          sourceOrderFile: "orders_30subs.json"
        };

        const blob = new Blob([JSON.stringify(payload, null, 2)], {
          type: "application/json"
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const timestamp = new Date()
          .toISOString()
          .replace(/[:.]/g, "-")
          .slice(0, 19);
        a.href = url;
        a.download = `vr_answers_pid${participantId || "NA"}_${timestamp}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
    </script>
  </body>
</html>
